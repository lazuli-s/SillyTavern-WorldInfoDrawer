name: Prepare main

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Branch to prepare from"
        required: true
        default: "dev"
      target_branch:
        description: "Branch to open the PR into"
        required: true
        default: "main"

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-main:
    runs-on: ubuntu-latest
    env:
      PREP_BRANCH: prepare-main/${{ inputs.source_branch }}
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_branch }}
          fetch-depth: 0

      - name: Remove disallowed files
        shell: bash
        run: |
          set -euo pipefail
          allowed_files=(index.js style.css manifest.json README.md)
          allowed_dirs=(src .github)

          in_allowed_files() {
            local item="$1"
            for allowed in "${allowed_files[@]}"; do
              if [[ "$item" == "$allowed" ]]; then
                return 0
              fi
            done
            return 1
          }

          in_allowed_dirs() {
            local item="$1"
            for allowed in "${allowed_dirs[@]}"; do
              if [[ "$item" == "$allowed" ]]; then
                return 0
              fi
            done
            return 1
          }

          shopt -s dotglob
          for item in *; do
            if [[ "$item" == ".git" ]]; then
              continue
            fi

            if [[ -d "$item" ]]; then
              if ! in_allowed_dirs "$item"; then
                rm -rf -- "$item"
              fi
              continue
            fi

            if [[ -f "$item" ]]; then
              if ! in_allowed_files "$item"; then
                rm -f -- "$item"
              fi
            fi
          done

      - name: Commit and push prepare branch
        id: prepare
        shell: bash
        run: |
          set -euo pipefail
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git checkout -B "$PREP_BRANCH"
          git add -A

          if git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No cleanup changes detected."
            exit 0
          fi

          git commit -m "chore: prepare main from ${{ inputs.source_branch }}"
          git push --force-with-lease origin "$PREP_BRANCH"
          echo "has_changes=true" >> "$GITHUB_OUTPUT"

      - name: Create or update PR to target branch
        if: steps.prepare.outputs.has_changes == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          title="chore: prepare main from ${{ inputs.source_branch }}"
          body=$(cat <<'EOF'
          Automated prepare-main PR.

          - Source branch: `${{ inputs.source_branch }}`
          - Target branch: `${{ inputs.target_branch }}`
          - Files were filtered to the extension allowlist before this PR was created.
          EOF
          )

          pr_number="$(gh pr list \
            --head "$PREP_BRANCH" \
            --base "${{ inputs.target_branch }}" \
            --state open \
            --json number \
            --jq '.[0].number')"

          if [[ -n "$pr_number" ]]; then
            gh pr edit "$pr_number" --title "$title" --body "$body"
            echo "Updated existing PR #$pr_number"
          else
            gh pr create \
              --head "$PREP_BRANCH" \
              --base "${{ inputs.target_branch }}" \
              --title "$title" \
              --body "$body"
            echo "Created a new PR."
          fi
