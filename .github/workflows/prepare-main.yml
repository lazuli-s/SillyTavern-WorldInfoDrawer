name: Prepare main

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: "Branch to prepare from"
        required: true
        default: "dev"
      target_branch:
        description: "Branch to open the PR into"
        required: true
        default: "main"

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-main:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.source_branch }}
          fetch-depth: 0

      - name: Remove disallowed files
        shell: bash
        run: |
          set -euo pipefail
          allowed_files=(index.js style.css manifest.json README.md)
          allowed_dirs=(src .github)

          in_allowed_files() {
            local item="$1"
            for allowed in "${allowed_files[@]}"; do
              if [[ "$item" == "$allowed" ]]; then
                return 0
              fi
            done
            return 1
          }

          in_allowed_dirs() {
            local item="$1"
            for allowed in "${allowed_dirs[@]}"; do
              if [[ "$item" == "$allowed" ]]; then
                return 0
              fi
            done
            return 1
          }

          shopt -s dotglob
          for item in *; do
            if [[ "$item" == ".git" ]]; then
              continue
            fi

            if [[ -d "$item" ]]; then
              if ! in_allowed_dirs "$item"; then
                rm -rf -- "$item"
              fi
              continue
            fi

            if [[ -f "$item" ]]; then
              if ! in_allowed_files "$item"; then
                rm -f -- "$item"
              fi
            fi
          done

      - name: Create PR to target branch
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: prepare main from ${{ inputs.source_branch }}"
          title: "chore: prepare main from ${{ inputs.source_branch }}"
          body: |
            Automated prepare-main PR.

            - Source branch: `${{ inputs.source_branch }}`
            - Target branch: `${{ inputs.target_branch }}`
            - Files were filtered to the extension allowlist before this PR was created.
          branch: prepare-main/${{ inputs.source_branch }}
          base: ${{ inputs.target_branch }}
          delete-branch: false
