/*
  SillyTavern World Info Drawer (STWID)

  Phase 1 CSS refactor: organization + safe micro-dedup only.
  Intent: preserve behavior; this file should read top-to-bottom as a UI tour.
*/

/* -------------------------------------------------------------------------- */

/* 1) Drawer                                                                  */

/* -------------------------------------------------------------------------- */

/* Hide the custom drawer body unless the extension has activated the drawer. */
body #WorldInfo > .stwid--body {
  display: none;
}

/* Drawer root sizing + layout */
body.stwid-- #WorldInfo {
  /* Phase 2: extension-scoped tokens (keep visuals unchanged) */
  --stwid-gap-xs: 0.25em;
  --stwid-gap-s: 0.35em;
  --stwid-gap-m: 0.5em;
  --stwid-radius-s: 4px;
  --stwid-radius-m: 6px;
  --stwid-radius-l: 8px;
  --stwid-radius-xl: 10px;
  --stwid-control-height: 2.35em;
  --stwid-splitter-width: 6px;
  --stwid-splitter-margin-x: 10px;

  /* Phase 4: component primitives (menus, buttons, control hit targets) */
  --stwid-hit-padding-y: 0.15em;
  --stwid-hit-padding-x: 0.25em;
  --stwid-focus-ring-color: var(--SmartThemeQuoteColor);
  --stwid-focus-ring: 2px solid var(--stwid-focus-ring-color);
  --stwid-focus-ring-offset: 2px;

  /* Phase 5: state styling primitives (consistent selection/target/focus) */
  --stwid-state-target-bg: color-mix(in srgb, var(--SmartThemeQuoteColor) 15%, rgb(var(--primaryBgCol, var(--SmartThemeBlurTintColor))));
  --stwid-state-target-outline: inset 0 0 0 1px color-mix(in srgb, var(--SmartThemeQuoteColor) 55%, transparent);
  --stwid-state-selected-bg: rgb(from var(--SmartThemeQuoteColor) r g b / 0.125);
  --stwid-state-selected-bg-strong: rgb(from var(--SmartThemeQuoteColor) r g b / 0.25);
  --stwid-state-hover-bg: var(--white20a);
  --stwid-state-disabled-opacity: 0.5;

  /* Phase 3: layout stability (inner content scrolls) */
  width: 100vw;
  height: calc(100dvh - var(--topBarBlockSize));
  max-height: unset;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
  min-height: 0;
}

/* Show drawer when ST sets openDrawer */
body.stwid-- #WorldInfo.openDrawer {
  display: flex !important;
}

/* Hide the vanilla WI UI when drawer is active */
body.stwid-- #WorldInfo #wi-holder {
  display: none;
}

/* Drawer main split layout */
body.stwid-- #WorldInfo > .stwid--body {
  flex: 1 1 auto;
  display: flex;
  gap: 0;
  overflow: hidden;
  min-width: 0;
  min-height: 0;
}

/* Loading overlay */
body.stwid-- #WorldInfo > .stwid--body.stwid--isLoading {
  pointer-events: none;
}

body.stwid-- #WorldInfo > .stwid--body.stwid--isLoading::after {
  content: 'Loading...';
  position: absolute;
  inset: 0;
  backdrop-filter: blur(4px) !important;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 5em;
}

/* -------------------------------------------------------------------------- */

/* 2) List Panel                                                              */

/* -------------------------------------------------------------------------- */

body.stwid-- #WorldInfo .stwid--list {
  flex: 0 0 auto;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  width: 300px;
  min-width: 0;
  min-height: 0;
}

/* Top controls (new book/folder, import/export, search, etc.) */
body.stwid-- #WorldInfo .stwid--list .stwid--controls {
  display: flex;
  flex-direction: column;
  gap: 0.25em;
  align-items: stretch;
}

body.stwid-- #WorldInfo .stwid--list .stwid--controls .stwid--controlsRow {
  --stwid-control-height: 2.35em;

  display: flex;
  gap: 0.25em;
  align-items: center;
  flex-wrap: wrap;
}

body.stwid-- #WorldInfo .stwid--list .stwid--controls .stwid--orderControls {
  flex-wrap: nowrap;
}

body.stwid-- #WorldInfo .stwid--list .stwid--controls .stwid--orderControls .text_pole {
  height: var(--stwid-control-height);
  padding: 0.35em;
  display: inline-flex;
  align-items: center;
  box-sizing: border-box;
}

body.stwid-- #WorldInfo .stwid--list .stwid--controls .stwid--controlsRow .stwid--bookSortToggle,
body.stwid-- #WorldInfo .stwid--list .stwid--controls .stwid--controlsRow .stwid--clearBookSorts {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.35em;
  height: var(--stwid-control-height);
}

body.stwid-- #WorldInfo .stwid--list .stwid--controls .stwid--active {
  color: var(--SmartThemeQuoteColor);
}

/* Search / active filter row */
body.stwid-- #WorldInfo .stwid--list .stwid--filter {
  display: flex;
  flex-direction: column;
  gap: 0.45em;
  align-items: stretch;
}

body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--filterRow {
  display: flex;
  gap: 0.75em;
  align-items: center;
  flex-wrap: wrap;
}

body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--filterRow--visibility {
  padding-top: 0.1em;
}

body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--filterRow--search .stwid--search {
  flex: 1 1 12em;
  min-width: 10em;
}

body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--searchEntries,
body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--filterActive {
  display: flex;
  gap: 0.5em;
  align-items: center;
}

body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--bookVisibility {
  position: relative;
  display: flex;
  align-items: flex-start;
  gap: 0.35em;
  flex-wrap: nowrap;
  width: 100%;
  flex: 1 1 auto;
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownWrap {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 0.35em;
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownButton {
  display: inline-flex;
  align-items: center;
  gap: 0.25em;
  padding: var(--stwid-hit-padding-y) var(--stwid-hit-padding-x);
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownMenu {
  position: absolute;
  top: calc(100% + 0.35em);
  left: 0;
  background-color: color-mix(in srgb, var(--SmartThemeBlurTintColor) 90%, black 15%);
  border: 1px solid var(--SmartThemeBorderColor);
  border-radius: var(--stwid-radius-m);
  padding: 0.45em;
  display: none;
  flex-direction: column;
  gap: 0.3em;
  z-index: 3;
  min-width: max-content;
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownMenu.stwid--active {
  display: flex;
  width: max-content;
  opacity: 1 !important;
  background-color: var(--SmartThemeBlurTintColor) !important;
  backdrop-filter: blur(calc(var(--SmartThemeBlurStrength))) !important;
  box-shadow: 0 0 15px color-mix(in srgb, var(--SmartThemeBlurTintColor) 50%, transparent);
  border: 1px solid var(--SmartThemeBorderColor);
  text-shadow: 0 0 calc(var(--shadowWidth) * 1px) var(--SmartThemeShadowColor);
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownOption {
  display: flex;
  align-items: center;
  gap: 0.35em;
  font-size: 1em;
  transition: color 150ms ease, background-color 150ms ease;
  padding: 2px 4px;
  border-radius: var(--stwid-radius-s);
  border: 0;
  color: inherit;
  background: transparent;
  cursor: pointer;
  text-align: left;
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownOption:hover {
  color: var(--customThemeColor) !important;
  background-color: color-mix(in srgb, var(--customThemeColor) 20%, transparent);
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownOption.stwid--active {
  color: var(--SmartThemeQuoteColor);
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownOption:focus-visible {
  outline: var(--stwid-focus-ring);
  outline-offset: 1px;
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownOption .stwid--multiselectDropdownOptionIcon {
  color: var(--customThemeColor);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  width: 1em;
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownOption .stwid--multiselectDropdownOptionCheckbox {
  width: 1em;
  text-align: center;
  color: var(--SmartThemeEmColor);
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownOption.stwid--active .stwid--multiselectDropdownOptionCheckbox {
  color: var(--SmartThemeQuoteColor);
}

.stwid--multiselectDropdownOption .stwid--multiselectDropdownOptionCheckbox.fa-square-check {
  color: var(--SmartThemeQuoteColor);
}

body.stwid-- #WorldInfo .stwid--multiselectDropdownOptionInput {
  position: absolute;
  width: 0;
  height: 0;
  margin: 0;
  opacity: 0;
  pointer-events: none;
}

body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--bookVisibility .stwid--multiselectDropdownWrap {
  flex: 0 0 auto;
}

body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--bookVisibility .stwid--bookVisibilityHelp {
  opacity: 0.7;
  cursor: help;
  color: var(--SmartThemeEmColor);
}

body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--visibilityChips {
  display: flex;
  align-items: center;
  align-content: flex-start;
  gap: 0.35em;
  flex-wrap: wrap;
  flex: 1 1 auto;
  min-width: 0;
  align-self: center;
}

body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--visibilityChip {
  display: inline-flex;
  align-items: center;
  gap: 0.25em;
  border: 1px solid var(--SmartThemeBorderColor);
  border-radius: 999px;
  padding: 0.1em 0.45em;
  font-size: 0.8em;
  background-color: color-mix(in srgb, var(--SmartThemeBlurTintColor) 85%, black 10%);
}

body.stwid-- #WorldInfo .stwid--list .stwid--filter .stwid--visibilityChip .stwid--icon {
  color: var(--SmartThemeQuoteColor);
}

/* Scrollable book list */
body.stwid-- #WorldInfo .stwid--list .stwid--books {
  flex: 1 1 auto;
  overflow: auto;
  min-height: 0;
}

/* Folders */
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder {
  border-bottom: 2px solid var(--SmartThemeBorderColor);
  border-radius: 8px;
  margin: 0.35em 0;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderHeader {
  display: flex;
  align-items: center;
  gap: 0.5em;
  padding: 0.35em 0;
  cursor: pointer;
  background-color: rgb(var(--primaryBgCol, var(--SmartThemeBlurTintColor)));
  transition: background-color 150ms ease, box-shadow 150ms ease;
  min-height: 2.2em;
  line-height: 1;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder.stwid--isTarget .stwid--folderHeader {
  background-color: var(--stwid-state-target-bg);
  box-shadow: var(--stwid-state-target-outline);
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderIcon {
  color: var(--SmartThemeQuoteColor);
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderLabel {
  font-weight: bold;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 1.2;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderCount {
  opacity: 0.85;
  background-color: color-mix(in srgb, var(--SmartThemeBodyColor) 12%, transparent);
  border-radius: 999px;
  padding: 0.1em 0.45em;
  font-size: 0.85em;
  line-height: 1.2;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderToggle {
  margin-left: auto;
  opacity: 0.75;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderIcon,
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderToggle,
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderActiveToggle,
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderAction,
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderMenu {
  display: inline-flex;
  align-items: center;
  line-height: 1;
  vertical-align: middle;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderActiveToggle {
  cursor: pointer;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderActiveToggle[data-state='partial']::before {
  content: '';
  transform: scale(1);
  width: 0.65em;
  height: 2px;
  border-radius: 999px;
  clip-path: none;
  box-shadow: none;
  background-color: var(--SmartThemeCheckboxTickColor);
}

/* Folder header buttons */
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderAction,
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderMenu {
  cursor: pointer;
  opacity: 0.75;
  transition: 200ms;
  border-radius: 6px;
  padding: 0;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder :is(.stwid--folderToggle, .stwid--folderActiveToggle, .stwid--folderAction, .stwid--folderMenu):focus-visible {
  outline: var(--stwid-focus-ring);
  outline-offset: var(--stwid-focus-ring-offset);
  opacity: 1;
}

/* Folder header layout tweaks when menu exists */
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderHeader.stwid--hasMenu .stwid--folderMenu,
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderHeader.stwid--hasMenu .stwid--folderToggle {
  margin-left: 0;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--folder
  .stwid--folderHeader.stwid--hasMenu
  .stwid--folderActiveToggle {
  margin-left: auto;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--folder .stwid--folderBooks.stwid--isCollapsed {
  display: none;
}

/* Books */
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book {
  border-bottom: 2px solid var(--SmartThemeBorderColor);
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book.stwid--isTarget,
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book.stwid--isTarget .stwid--head {
  background-color: var(--stwid-state-selected-bg);
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book.stwid--filter-active,
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book.stwid--filter-visibility,
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book.stwid--filter-query {
  display: none;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book:has(.stwid--entryList .stwid--entry.stwid--active)
  .stwid--head {
  background-color: var(--white20a);
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--head {
  display: flex;
  gap: 0.5em;
  background-color: rgb(var(--primaryBgCol, var(--SmartThemeBlurTintColor)));
  position: sticky;
  top: 0;
  z-index: 1;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--head .stwid--title {
  flex: 1 1 auto;
  cursor: pointer;
  font-weight: bold;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--head .stwid--actions {
  display: flex;
  gap: 0.25em;
  align-items: center;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--head .stwid--actions .stwid--sourceLinks {
  display: inline-flex;
  gap: 0.1em;
  align-items: center;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--head .stwid--actions .stwid--sourceLinks.stwid--isEmpty {
  display: none;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--head .stwid--actions .stwid--sourceLinks .stwid--sourceIcon {
  opacity: 0.75;
  color: var(--SmartThemeQuoteColor);
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--head
  .stwid--actions
  .stwid--action {
  cursor: pointer;
  opacity:  0.5;
  transition: 200ms;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--head
  .stwid--actions
  .stwid--action:hover {
  opacity: 1;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entryList.stwid--isCollapsed {
  display: none;
}

/* Entries */
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--entry {
  display: flex;
  gap: 0.5em;
  border-bottom: 2px solid var(--SmartThemeBorderColor);
  margin-left: 0.25em;
  overflow: hidden;
  transition: 200ms;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entry:is(.stwid--isDragging .stwid--entry:not(.stwid--isSelected)) {
  pointer-events: none;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--entry.stwid--isSelected {
  background-color: var(--stwid-state-selected-bg);
  cursor: grab;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entry.stwid--isSelected:hover,
body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entry.stwid--isSelected.stwid--active {
  background-color: var(--stwid-state-selected-bg-strong);
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entry.stwid--isSelected
  *:not(:is(.stwid--selector)) {
  pointer-events: none;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--entry.stwid--filter-query {
  display: none;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--entry:hover,
body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--entry.stwid--active {
  background-color: var(--stwid-state-hover-bg);
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--entry:hover .stwid--status,
body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entry.stwid--active
  .stwid--status {
  opacity: 1;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entry:has(.stwid--enabled.fa-toggle-off) {
  opacity: var(--stwid-state-disabled-opacity);
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--entry .stwid--selector {
  display: flex;
  align-items: center;
  opacity: 0.25;
  transition: 200ms;
  cursor: pointer;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entry
  .stwid--selector:hover {
  opacity: 1;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--entry .stwid--body {
  flex: 1 1 auto;
  cursor: pointer;
  overflow: hidden;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entry
  .stwid--body
  .stwid--comment {
  height: 1lh;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entry
  .stwid--body
  .stwid--key {
  color: var(--SmartThemeEmColor);
  font-size: smaller;
  font-style: italic;
  height: 1lh;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

body.stwid-- #WorldInfo .stwid--list .stwid--books .stwid--book .stwid--entry .stwid--status {
  align-self: center;
  display: flex;
  gap: 0.5em;
  align-items: baseline;
  opacity: 0.5;
  transition: 200ms;
}

body.stwid--
  #WorldInfo
  .stwid--list
  .stwid--books
  .stwid--book
  .stwid--entry
  .stwid--status
  .stwid--enabled {
  color: var(--SmartThemeQuoteColor);
  cursor: pointer;
}

/* -------------------------------------------------------------------------- */

/* 3) Splitter                                                                */

/* -------------------------------------------------------------------------- */

body.stwid-- #WorldInfo .stwid--splitter {
  flex: 0 0 auto;
  width: var(--stwid-splitter-width);
  margin: 0 var(--stwid-splitter-margin-x);
  cursor: col-resize;
  background: var(--SmartThemeBorderColor);
  opacity: 0.6;
  transition: opacity 0.15s ease-in-out;
}

body.stwid-- #WorldInfo .stwid--splitter:hover,
body.stwid-- #WorldInfo .stwid--splitter:active {
  opacity: 1;
}

/* -------------------------------------------------------------------------- */

/* 4) Editor Panel                                                            */

/* -------------------------------------------------------------------------- */

body.stwid-- #WorldInfo .stwid--editor {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
  min-height: 0;
}

body.stwid-- #WorldInfo .stwid--editor:empty::after {
  content: '\f558';
  font-family: 'Font Awesome 6 Free', sans-serif;
  font-size: 20em;
  opacity: 0.125;
  display: flex;
  height: 100%;
  align-items: center;
  justify-content: center;
}

body.stwid-- #WorldInfo .stwid--editor #wiActivationSettings {
  flex-wrap: nowrap;
}

body.stwid-- #WorldInfo .stwid--editor #wiActivationSettings #wiCheckboxes {
  flex: 0 0 auto;
  width: unset;
}

body.stwid-- #WorldInfo .stwid--editor.stwid--focus #WIEntryHeaderTitlesPC,
body.stwid--
  #WorldInfo
  .stwid--editor.stwid--focus
  .world_entry
  *:not(:has([name='content']), [name='content'], :has([class*='stwim--']), [class*='stwim--']) {
  display: none;
}

body.stwid-- #WorldInfo .stwid--editor.stwid--focus .stwid--unfocusToggle {
  display: flex;
}

body.stwid-- #WorldInfo .stwid--editor.stwid--focus :has(> .stwim--pickerTriggerWrap) {
  justify-content: end;
}

body.stwid--
  #WorldInfo
  .stwid--editor.stwid--focus
  :has(> .stwim--pickerTriggerWrap)
  .stwim--pickerTriggerWrap {
  position: absolute;
  top: -3em;
  right: 0;
}

body.stwid-- #WorldInfo .stwid--editor .stwid--unfocusToggle {
  display: none;
}

body.stwid-- #WorldInfo .stwid--editor .stwid--focusToggle {
  margin-left: 1em;
}

body.stwid-- #WorldInfo .stwid--editor .world_entry,
body.stwid-- #WorldInfo .stwid--editor .world_entry_form,
body.stwid-- #WorldInfo .stwid--editor .inline-drawer {
  height: 100%;
}

body.stwid-- #WorldInfo .stwid--editor .inline-drawer {
  display: flex;
  flex-direction: column;
  min-height: 0;
}

body.stwid-- #WorldInfo .stwid--editor .drag-handle,
body.stwid-- #WorldInfo .stwid--editor .inline-drawer-toggle {
  display: none;
}

body.stwid-- #WorldInfo .stwid--editor .inline-drawer-content {
  flex: 1 1 auto;
  display: flex !important;
  flex-direction: column;
  min-height: 0;
}

body.stwid-- #WorldInfo .stwid--editor .inline-drawer-content > .world_entry_edit {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  min-height: 0;
}

body.stwid-- #WorldInfo .stwid--editor .inline-drawer-content > .world_entry_edit > :nth-child(1) {
  flex: 1 1 auto;
  flex-direction: column;
  align-items: stretch;
  min-height: 0;
}

body.stwid--
  #WorldInfo
  .stwid--editor
  .inline-drawer-content
  > .world_entry_edit
  .inline-drawer:has(> .userSettingsInnerExpandable) {
  display: none;
}

body.stwid-- #WorldInfo .stwid--editor [name='contentAndCharFilterBlock'] {
  flex: 1 1 auto !important;
  min-height: 0;
  min-width: 0;
}

body.stwid-- #WorldInfo .stwid--editor [name='content'] {
  flex: 1 1 auto;
  min-height: 0;
}

body.stwid-- #WorldInfo .stwid--editor [name='WIEntryBottomControls'] {
  display: none;
}

/* -------------------------------------------------------------------------- */

/* 5) Context Menu + Modals                                                   */

/* -------------------------------------------------------------------------- */

.stwid--blocker {
  position: fixed;
  inset: 0;
  z-index: 30000;
}

/* Shared menu/item patterns (Phase 4)
   Keep selectors local to this extension and avoid changing layout/positioning.
*/
body.stwid-- #WorldInfo :is(.stwid--action, .stwid--folderAction, .stwid--folderMenu, .stwid--folderToggle, .stwid--listDropdownTrigger, .stwid--multiselectDropdownButton, .stwid--orderFilterButton) {
  border-radius: var(--stwid-radius-m);
}

body.stwid-- #WorldInfo :is(.stwid--action, .stwid--folderAction, .stwid--folderMenu, .stwid--folderToggle, .stwid--listDropdownTrigger, .stwid--multiselectDropdownButton, .stwid--orderFilterButton):focus-visible {
  outline: var(--stwid-focus-ring);
  outline-offset: var(--stwid-focus-ring-offset);
}

/* Move Book to Folder dialog layout */
.stwid--moveBookContent {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.stwid--moveBookContent h3 {
  align-self: stretch;
  text-align: left;
}

.stwid--moveBookContent .stwid--moveBookRow {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 0.5em;
}

.stwid--moveBookContent .stwid--moveBookRow .text_pole {
  flex: 1 1 auto;
  min-width: 0;
}

.stwid--moveBookContent .stwid--moveBookQuickActions {
  flex: 0 0 auto;
  display: inline-flex;
  align-items: center;
  justify-content: flex-end;
  gap: 0.35em;
}

.stwid--moveBookContent .stwid--moveBookQuickActions .menu_button {
  min-width: 2.35em;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* Context menu container */
.stwid--blocker .stwid--listDropdownMenu {
  --stwid-menu-item-height: 2.05em;

  position: fixed;
  position-anchor: --stwid--ctxAnchor;
  position-area: bottom right;
  position-try-fallbacks: flip-block, flip-inline;
  margin-top: -1lh;
  filter: drop-shadow(1px 1px 2px var(--black50a));
  z-index: 30000;
  overflow: clip auto;
  border: 1px solid var(--SmartThemeBorderColor);
  border-radius: var(--stwid-radius-m);
  display: flex;
  flex-direction: column;
  background-color: color-mix(in srgb, var(--SmartThemeBlurTintColor) 95%, black 10%);
  font-size: 0.9em;
  padding: 0.5em;
}

.stwid--blocker .stwid--listDropdownMenu .stwid--listDropdownItem {
  min-height: var(--stwid-menu-item-height);
  height: var(--stwid-menu-item-height);
  opacity: 1;
  color: var(--SmartThemeBodyColor);
  background-color: rgba(255, 255, 255, 0);
  cursor: pointer;
  transition: background-color 200ms, color 200ms, opacity 200ms;
  display: flex;
  flex-direction: row;
  gap: 0.35em;
  align-items: center;
  box-sizing: border-box;
  padding: 3px;
  border-radius: var(--stwid-radius-m);
}

.stwid--blocker .stwid--listDropdownMenu .stwid--listDropdownItem:hover {
  background-color: color-mix(in srgb, var(--customThemeColor) 85%, black 15%);
}

.stwid--blocker .stwid--listDropdownMenu .stwid--listDropdownItem:focus-visible {
  outline: var(--stwid-focus-ring);
  outline-offset: var(--stwid-focus-ring-offset);
}

.stwid--blocker .stwid--listDropdownMenu .stwid--listDropdownItem .stwid--icon {
  flex: 0 0 auto;
  width: 1.05em;
  text-align: center;
}

.stwid--blocker .stwid--listDropdownMenu .stwid--listDropdownItem .stwid--label {
  flex: 1 1 auto;
  min-width: fit-content;
}

.stwid--blocker .stwid--listDropdownMenu .stwid--listDropdownItem #lorebook_ordering_button {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 0.35em;
}

.stwid--blocker .stwid--listDropdownMenu .stwid--listDropdownItem.stwid--bookSort {
  opacity: 1;
  cursor: default;
}

.stwid--blocker .stwid--listDropdownMenu .stwid--listDropdownItem.stwid--bookSort select {
  width: fit-content;
  color: inherit;
  background-color: rgba(255, 255, 255, 0.05);
  min-height: var(--stwid-menu-item-height);
  height: 100%;
  margin:  0;
  font-size: 1em;
}

/* -------------------------------------------------------------------------- */

/* 6) Order Helper (actions, filter, table)                                   */

/* -------------------------------------------------------------------------- */

/* Root */
.stwid--orderHelper {
  display: flex;
  flex-direction: column;
  flex: 1 1 auto;
  min-height: 0;
  overflow: hidden;
  min-width: 0;
}

/* Column toggles */
.stwid--orderHelper.stwid--hideKeys .stwid--key {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-strategy [data-col='strategy'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-position [data-col='position'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-depth [data-col='depth'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-outlet [data-col='outlet'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-group [data-col='group'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-order [data-col='order'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-sticky [data-col='sticky'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-cooldown [data-col='cooldown'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-delay [data-col='delay'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-automationId [data-col='automationId'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-trigger [data-col='trigger'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-recursion [data-col='recursion'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-budget [data-col='budget'] {
  display: none;
}

.stwid--orderHelper.stwid--hide-col-characterFilter [data-col='characterFilter'] {
  display: none;
}

/* Action bar */
.stwid--orderHelper .stwid--actions {
  flex: 0 0 auto;
  display: flex;
  gap: 1.25em;
  justify-content: flex-start;
  align-items: center;
  background-color: var(--SmartThemeBlurTintColor);
  padding: 0 0.5em;
}

.stwid--orderHelper .stwid--actions .stwid--actionsDivider {
  align-self: stretch;
  width: 1px;
  background-color: var(--SmartThemeBorderColor);
  opacity: 0.5;
}

.stwid--orderHelper .stwid--actions .stwid--inputWrap {
  display: flex;
  align-items: center;
  gap: 0.5em;
  color: var(--SmartThemeEmColor);
  font-size: smaller;
}

.stwid--orderHelper .stwid--actions .stwid--inputWrap .stwid--input {
  width: 33%;
  min-width: 4em;
}

.stwid--orderHelper .stwid--actions .stwid--columnVisibility {
  display: flex;
  align-items: center;
  gap: 0.5em;
  color: var(--SmartThemeEmColor);
  font-size: smaller;
  position: relative;
}

.stwid--orderHelper .stwid--actions .stwid--columnVisibility .stwid--columnVisibilityLabel {
  display: flex;
  align-items: center;
  gap: 0.35em;
}

.stwid--orderHelper .stwid--actions .stwid--columnVisibility .stwid--columnVisibilityText {
  line-height: 1.1;
}

.stwid--orderHelper .stwid--actions .stwid--actionsRight {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 0.75em;
}

.stwid--orderHelper .stwid--actions .stwid--actionsRight .stwid--actionsDivider {
  margin-right: 0.5em;
}

.stwid--orderHelper .stwid--multiselectDropdownMenu :is(.stwid--multiselectDropdownOption, .stwid--columnVisibilityLabel) {
  padding: 2px 4px;
  border-radius: var(--stwid-radius-s);
}

/* Filters */
.stwid--orderHelper .stwid--orderTable .stwid--columnHeader {
  display: flex;
  flex-direction: row;
  align-items: center;
  gap: 0.8em;
}

.stwid--orderHelper .stwid--orderTable .stwid--columnFilter {
  display: flex;
  align-items: center;
}

.stwid--orderHelper .stwid--orderTable .stwid--orderFilterButton {
  border: none;
  background: transparent;
  box-shadow: none;
  padding: var(--stwid-hit-padding-y) var(--stwid-hit-padding-x);
  min-height: 0;
  min-width: 0;
  line-height: 1;
  font-size: 0.85em;
}

.stwid--orderHelper .stwid--orderTable .stwid--orderFilterButton.stwid--active {
  opacity: 1;
  color: var(--SmartThemeQuoteColor);
}

.stwid--orderHelper .stwid--filter {
  background-color: var(--SmartThemeBlurTintColor);
  display: none;
  gap: 1em;
  height: 20vh;
}

.stwid--orderHelper .stwid--filter.stwid--active {
  display: flex;
}

.stwid--orderHelper .stwid--filter .stwid--main {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  gap: 0.5em;
}

.stwid--orderHelper .stwid--filter .stwid--main .stwid--hint {
  color: var(--SmartThemeEmColor);
  font-size: smaller;
}

.stwid--orderHelper .stwid--filter .stwid--main .stwid--hint code {
  font-size: smaller;
}

.stwid--orderHelper .stwid--filter .stwid--main .stwid--script {
  display: grid;
  grid-template-columns: 1fr;
  grid-template-rows: 1fr;
}

.stwid--orderHelper .stwid--filter .stwid--main .stwid--script .stwid--syntax,
.stwid--orderHelper .stwid--filter .stwid--main .stwid--script .stwid--input {
  grid-column: 1;
  grid-row: 1;
  height: 100%;
  width: 100%;
  font-family: var(--monoFontFamily, monospace);
  padding: 0.75em;
  margin: 0;
  line-height: 1.2;
  border: 1px solid var(--SmartThemeBorderColor);
  border-radius: 5px;
  white-space: pre;
  resize: none;
  tab-size: 4;
  max-height: unset;
}

.stwid--orderHelper .stwid--filter .stwid--main .stwid--script .stwid--input {
  caret-color: var(--ac-style-color-text);
}

.stwid--orderHelper .stwid--filter .stwid--main .stwid--script .stwid--input::-webkit-scrollbar,
.stwid--orderHelper
  .stwid--filter
  .stwid--main
  .stwid--script
  .stwid--input::-webkit-scrollbar-thumb {
  visibility: hidden;
}

.stwid--orderHelper .stwid--filter .stwid--main .stwid--script .stwid--input::selection {
  color: transparent;
  background-color: rgba(108 171 251 / 0.25);
}

@supports (rgb(from var(--ac-style-color-matchedText) r g b / 0.25)) {
  .stwid--orderHelper .stwid--filter .stwid--main .stwid--script .stwid--input::selection {
    background-color: rgb(from var(--ac-style-color-matchedText) r g b / 0.25);
  }
}

.stwid--orderHelper .stwid--filter .stwid--preview {
  font-family: var(--monoFontFamily, monospace);
  font-size: 0.6em;
  white-space: pre;
  max-width: 30%;
  overflow: auto;
  height: 100%;
}

/* Table wrapper */
.stwid--orderTableWrap {
  flex: 1 1 auto;
  min-height: 0;
  overflow: auto;
}

/* Table */
.stwid--orderTable {
  border: 0;
  border-collapse: collapse;
  border-spacing: 0;
  text-align: left;
  white-space: normal;
  width: 100%;
}

.stwid--orderTable thead {
  background-color: var(--SmartThemeBlurTintColor);
  position: sticky;
  top: 0;
  z-index: 1;
  font-size: smaller;
}

.stwid--orderTable tr {
  border-bottom: 5px solid var(--SmartThemeBorderColor);
  transition: 200ms;
  background-color: var(--primaryBgCol, var(--SmartThemeBlurTintColor));
}

.stwid--orderTable tr:hover {
  background-color: color-mix(in srgb, var(--SmartThemeQuoteColor) 50%, transparent 50%);
}

.stwid--orderTable tbody tr.stwid--isTarget {
  background-color: var(--stwid-state-target-bg);
  box-shadow: var(--stwid-state-target-outline);
}

.stwid--orderTable tbody tr.stwid--isTarget:hover {
  background-color: color-mix(in srgb, var(--SmartThemeQuoteColor) 25%, var(--stwid-state-target-bg));
}

.stwid--orderTable tbody tr.stwid--isSelected {
  background-color: var(--stwid-state-selected-bg);
}

.stwid--orderTable tbody tr.stwid--isSelected:hover {
  background-color: var(--stwid-state-selected-bg-strong);
}

.stwid--orderTable tr.stwid--isFiltered {
  display: none;
}

.stwid--orderTable tbody tr:not(.stwid--applySelected) {
  opacity: 0.6;
}

.stwid--orderTable tr:has(.stwid--enabled.fa-toggle-off) {
  opacity: var(--stwid-state-disabled-opacity);
}

.stwid--orderTable tr th,
.stwid--orderTable tr td {
  text-align: left;
  padding: 0 0.7em;
  width: 0;
}

.stwid--orderTable thead th {
  text-align: center;
}

.stwid--orderTable thead th[data-col='entry'] {
  text-align: left;
}

/* Table column sizing */
.stwid--orderHelper .stwid--orderTable tr th[data-col='select'],
.stwid--orderHelper .stwid--orderTable tr td[data-col='select'] {
  min-width: 1em;
  text-align: center;
}

.stwid--orderHelper .stwid--orderTable tr th[data-col='drag'],
.stwid--orderHelper .stwid--orderTable tr td[data-col='drag'] {
  min-width: 1.5em;
  text-align: center;
}

.stwid--orderHelper .stwid--orderTable tr th[data-col='enabled'],
.stwid--orderHelper .stwid--orderTable tr td[data-col='enabled'] {
  min-width: 1em;
  text-align: center;
}

.stwid--orderHelper .stwid--orderTable tr th[data-col='entry'],
.stwid--orderHelper .stwid--orderTable tr td[data-col='entry'] {
  min-width: 16em;
  padding-top: 1em;
  padding-bottom: 1em;
}

.stwid--orderHelper .stwid--orderTable tr th[data-col='strategy'],
.stwid--orderHelper .stwid--orderTable tr td[data-col='strategy'] {
  min-width: 5em;
}

.stwid--orderHelper .stwid--orderTable tr th[data-col='position'],
.stwid--orderHelper .stwid--orderTable tr td[data-col='position'] {
  min-width: 7em;
}

.stwid--orderHelper .stwid--orderTable tr th[data-col='outlet'],
.stwid--orderHelper .stwid--orderTable tr td[data-col='outlet'] {
  min-width: 8em;
}

.stwid--orderHelper .stwid--orderTable .stwid--orderTable--NumberColumns {
  min-width: 5em;
}

.stwid--orderHelper .stwid--orderTable tr th[data-col='recursion'],
.stwid--orderHelper .stwid--orderTable tr td[data-col='recursion'] {
  min-width: 14em;
}

.stwid--orderHelper .stwid--orderTable tr th[data-col='characterFilter'],
.stwid--orderHelper .stwid--orderTable tr td[data-col='characterFilter'] {
  min-width: 14em;
}

.stwid--orderHelper .stwid--orderTable tr th[data-col='budget'],
.stwid--orderHelper .stwid--orderTable tr td[data-col='budget'] {
  min-width: 7em;
}

/* Row details */
.stwid--orderHelper .stwid--recursionOptions,
.stwid--orderHelper .stwid--characterFilterOptions {
  display: flex;
  flex-direction: column;
  gap: 0;
  font-size: 0.85em;
}

.stwid--orderHelper .stwid--characterFilterRow,
.stwid--orderHelper .stwid--recursionRow {
  display: flex;
  align-items: center;
  gap: 0.4em;
}

.stwid--orderHelper .stwid--characterFilterRow--include {
  color: var(--SmartThemeQuoteColor);
}

.stwid--orderHelper .stwid--characterFilterRow--exclude {
  color: var(--SmartThemeErrorColor, #e57373);
}

.stwid--orderHelper .stwid--recursionRow .checkbox {
  width: 0.85em;
  height: 0.85em;
}

.stwid--orderHelper .stwid--recursionOptions br {
  display: none;
}

.stwid--orderTable tr td {
  color: rgb(from var(--SmartThemeBodyColor) r g b / 0.75);
  font-size: small;
}

.stwid--orderTable tr td .stwid--sortableHandle {
  cursor: pointer;
  opacity: 0.5;
  padding: 2px;
  font-size: 0.85em;
  transition: 200ms;
}

.stwid--orderTable tr td .stwid--sortableHandle:hover {
  opacity: 1;
}

.stwid--orderTable tr td .stwid--orderMove {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.40em;
}

.stwid--orderTable tr td .stwid--orderMoveButton {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  border: none;
  background: transparent;
  color: var(--SmartThemeQuoteColor);
  cursor: pointer;
  opacity: 0.6;
  transition: opacity 150ms ease;
}

.stwid--orderTable tr td .stwid--orderMoveButton:hover {
  opacity: 1;
  color: var(--SmartThemeQuoteColor);
  text-shadow: 0 0 6px color-mix(in srgb, var(--SmartThemeQuoteColor) 65%, transparent);
  outline: 1px solid color-mix(in srgb, var(--SmartThemeQuoteColor) 50%, transparent);
  border-radius: 4px;
}

.stwid--orderTable tr td .stwid--orderMoveButton:focus-visible,
.stwid--orderTable tr td .stwid--sortableHandle:focus-visible,
.stwid--orderTable tr td .stwid--orderSelect:focus-visible {
  outline: var(--stwid-focus-ring);
  outline-offset: 1px;
  opacity: 1;
}

.stwid--orderTable tr td .stwid--orderSelect {
  color: var(--SmartThemeQuoteColor);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.25em;
  transition: 200ms;
}

.stwid--orderTable tr td .stwid--orderSelect:hover {
  opacity: 0.8;
}

.stwid--orderTable tr td .stwid--orderSelect .stwid--icon {
  pointer-events: none;
}

.stwid--orderTable tr td [name='depth'] {
  display: none;
}

.stwid--orderTable tr td:has([name='position'] > [value='4']:checked) + td > [name='depth'] {
  display: inline-block;
}

.stwid--orderTable tr td:has(.stwid--entry) {
  width: 100%;
}

.stwid--orderTable tr td:has(.stwid--entry) .stwid--book {
  color: var(--SmartThemeEmColor);
  font-size: 0.8em;
  line-height: 1;
}

.stwid--orderTable tr td:has(.stwid--entry) .stwid--commentLink {
  color: inherit;
}

.stwid--orderTable tr td:has(.stwid--entry) a.stwid--comment.stwid--commentLink {
  font-size: 1.1em;
  font-weight: 500;
}

.stwid--orderTable tr td:has(.stwid--entry) .stwid--key {
  color: var(--SmartThemeEmColor);
  font-size: 0.75em;
  font-style: italic;
  line-height: 1;
}

.stwid--orderTable tr td .stwid--outlet {
  color: var(--SmartThemeBodyColor);
  font-size: 0.85em;
  min-width: 6em;
}

.stwid--orderTable tr td .stwid--outlet input[name='outletName'] {
  width: 100%;
  min-width: 7em;
}

.stwid--orderHelper .stwid--orderInputTight,
.stwid--orderHelper
  .stwid--orderTable
  input:is(
    [name='depth'],
    [name='order'],
    [name='sticky'],
    [name='cooldown'],
    [name='delay'],
    [name='automationId'],
    [name='selective_probability']
  ) {
  min-height: 5px;
  padding-left: 5px;
  padding-right: 5px;
  font-size: 0.95em;
}

.stwid--orderTable tr td .stwid--position {
  font-size: 0.9em;
}

.stwid--orderTable tr td input[name='depth'],
.stwid--orderTable tr td input[name='order'],
.stwid--orderTable tr td input[name='selective_probability'] {
  min-width: 4em;
  font-size: 0.95em;
}

.stwid--orderTable tr td .stwid--enabled {
  color: var(--SmartThemeQuoteColor);
  cursor: pointer;
}

/* -------------------------------------------------------------------------- */

/* 7) Misc                                                                    */

/* -------------------------------------------------------------------------- */

.stwid--helpToast {
  margin: 0;
  padding-left: 0.5em;
  font-size: small;
}
